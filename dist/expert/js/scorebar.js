/*
*
* PHYLO Distribution Build v3.1.0
* http://phylo.cs.mcgill.ca
*
* Copyright 2013 McGill university, Alfred Kam, Jerome Waldispuhl and other contributors
* Under McGill Human-Computing Developer Licence
* https://github.com/McGill-CSB/PHYLO/blob/master/McGill-LICENCE.txt
*
*/function ColourConversion(){return!0}function ScoreBar(a){return this.canvas=a,this.ctx=a.getContext("2d"),this.currentScore=10,this.bestScore=0,this.parScore=0,this.params={animate:{from:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},to:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},current:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},interval:20,duration:500,handle:null,start:null,circIn:function(a){return 1-Math.sin(Math.acos(a))},circOut:function(a){return Math.sin(Math.acos(1-a))},circInOut:function(a){return.5>a?.5-Math.sin(Math.acos(2*a))/2:.5+Math.sin(Math.acos(2-2*a))/2},step:function(a,b){b.animate.current.left=b.animate.from.left+(b.animate.to.left-b.animate.from.left)*a,b.animate.current.right=b.animate.from.right+(b.animate.to.right-b.animate.from.right)*a,b.animate.current.currentScore=b.animate.from.currentScore+(b.animate.to.currentScore-b.animate.from.currentScore)*a,b.animate.current.bestScore=b.animate.from.bestScore+(b.animate.to.bestScore-b.animate.from.bestScore)*a,b.animate.current.parScore=b.animate.from.parScore+(b.animate.to.parScore-b.animate.from.parScore)*a,b.animate.current.grid=Math.pow(10,Math.floor(Math.log(b.animate.current.right-b.animate.current.left)/Math.log(10)-.4))}},barHeight:.4,leftBlank:100,rightBlank:100,colours:{gridLine:"rgba(200,200,200,0.3)",gridText:"rgba(200,200,200,0.9)",bestScoreLine:"rgb(120,250,120)",parScoreLine:"rgb(120,120,250)",bestScoreText:"rgb(120,250,120)",parScoreText:"rgb(120,120,250)",parBackground:"",barLow:[0,1,.5],barMid:[.2,1,.5],barHigh:[.44,1,.5],barRange:30,barAlpha:.9,barTextFill:"white",barTextShadow:"rgba(0,0,0,0.9)",scoreText:"rgba(74,74,74,0.9)"}},this.listeners={"best-click":[]},this.params.animate.draw=this.draw,!0}ColourConversion.rgbToRgbaString=function(a,b){return"rgba("+~~(a[0]+.5)+","+~~(a[1]+.5)+","+~~(a[2]+.5)+","+b+")"},ColourConversion.rgbToHsl=function(a,b,c){a/=255,b/=255,c/=255;var d,e,f=Math.max(a,b,c),g=Math.min(a,b,c),h=(f+g)/2;if(f==g)d=e=0;else{var i=f-g;switch(e=h>.5?i/(2-f-g):i/(f+g),f){case a:d=(b-c)/i+(c>b?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return[d,e,h]},ColourConversion.hslToRgb=function(a,b,c){function d(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}var e,f,g;if(0==b)e=f=g=c;else{var h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;e=d(i,h,a+1/3),f=d(i,h,a),g=d(i,h,a-1/3)}return[255*e,255*f,255*g]},ScoreBar.alignToPixel=function(a){return~~a+.5},ScoreBar.prototype.getBarColour=function(a){void 0===a&&(a=this.params.animate.current.currentScore);var b=this.params.colours.barRange,c=Math.abs(a-this.parScore)/b;c>1&&(c=1);var d=this.params.colours.barMid,e=this.params.colours.barLow;return a>=this.parScore&&(e=this.params.colours.barHigh),ColourConversion.rgbToRgbaString(ColourConversion.hslToRgb(c*(e[0]-d[0])+d[0],c*(e[1]-d[1])+d[1],c*(e[2]-d[2])+d[2]),this.params.colours.barAlpha)},ScoreBar.prototype.draw=function(){"undefined"!=typeof resizeinfo&&resizeinfo.resize&&(this.canvas.width=resizeinfo.scorebar_width);var a=this.ctx,b=this.canvas.width,c=this.canvas.height,d=this.params.animate;a.save(),a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,b,c),a.restore(),b-=this.params.leftBlank+this.params.rightBlank;var e=b/(d.current.right-d.current.left),f=Math.abs(Math.min(d.current.left,0))/(d.current.right-d.current.left),g=f*b+this.params.leftBlank;a.font="10pt sans-serif",a.textBaseline="bottom",a.textAlign="center",a.strokeStyle=this.params.colours.gridLine,a.fillStyle=this.params.colours.gridText,a.lineWidth=1,a.beginPath();for(var h=g;h<=this.canvas.width;)a.moveTo(ScoreBar.alignToPixel(h),0),a.lineTo(ScoreBar.alignToPixel(h),c),a.fillText(""+Math.round((h-g)/e*10)/10,h,c),h+=d.current.grid*e;for(h=g;h>=0;)a.moveTo(ScoreBar.alignToPixel(h),0),a.lineTo(ScoreBar.alignToPixel(h),c),a.fillText(Math.round((h-g)/e*10)/10,h,c),h-=d.current.grid*e;a.closePath(),a.stroke(),h=this.params.animate.current.currentScore*e,a.fillStyle=this.getBarColour(),a.textBaseline="middle";var i=ScoreBar.getRect.call(this,this.params.animate.current.currentScore,e,g);a.beginPath(),a.rect(i.left,i.top,i.width,i.height),a.closePath(),a.fill(),a.fillStyle=this.params.colours.barTextFill,a.lineWidth=2,a.save(),a.shadowColor=this.params.colours.barTextShadow,a.shadowOffsetX=a.shadowOffsetY=0,a.shadowBlur=2,a.fillText(Math.round(this.params.animate.current.currentScore),h/2+g,c/2),a.restore(),h=ScoreBar.alignToPixel(g+this.params.animate.current.bestScore*e),a.textBaseline="top",a.textAlign="left",a.fillStyle=this.params.colours.bestScoreText,a.fillText(Language.get("sb-best")+": "+Math.round(this.params.animate.current.bestScore),b+this.params.leftBlank+10,0),a.beginPath(),a.moveTo(h,0),a.lineTo(h,c),a.closePath(),a.strokeStyle=this.params.colours.bestScoreLine,a.stroke(),h=ScoreBar.alignToPixel(g+this.params.animate.current.parScore*e),a.textBaseline="middle",a.fillStyle=this.params.colours.parScoreText,a.fillText(Language.get("sb-par")+": "+Math.round(this.params.animate.current.parScore),b+this.params.leftBlank+10,c/2),a.beginPath(),a.moveTo(h,0),a.lineTo(h,c),a.closePath(),a.strokeStyle=this.params.colours.parScoreLine,a.stroke(),a.save(),a.font="22pt sans-serif",a.fillStyle=this.params.colours.scoreText,a.textAlign="center",a.textBaseline="middle",a.fillText(Math.round(this.params.animate.current.currentScore),this.params.leftBlank/2,c/2),a.restore()},ScoreBar.getRect=function(a,b,c){var d={},e=this.canvas.height;return d.top=e*(1-this.params.barHeight)/2,d.height=this.params.barHeight*e,d.left=Math.min(a*b+c,c),d.width=Math.abs(a*b),d},ScoreBar.prototype.recalc=function(){var a=function(a){var b=a.params.animate;null!=b.handle&&(clearInterval(b.handle),b.handle=null),b.start=new Date,b.handle=setInterval(function(){var c=new Date-b.start,d=c/b.duration;d>1&&(d=1),b.step(b.circInOut(d),a.params),a.draw(),1==d&&(clearInterval(b.handle),b.handle=null)},b.interval)},b=1.2*Math.min(this.currentScore,this.bestScore,this.parScore),c=1.2*Math.max(this.currentScore,this.bestScore,this.parScore);if(b>0&&(b=0),0>c&&(c=0),10>c-b){var d=5-(c-b)/2;c+=d,b-=d}this.params.animate.from.left=this.params.animate.current.left,this.params.animate.from.right=this.params.animate.current.right,this.params.animate.from.grid=this.params.animate.current.grid,this.params.animate.from.currentScore=this.params.animate.current.currentScore,this.params.animate.from.bestScore=this.params.animate.current.bestScore,this.params.animate.from.parScore=this.params.animate.current.parScore,this.params.animate.to.left=b,this.params.animate.to.right=c,this.params.animate.to.grid=Math.pow(10,Math.floor(Math.log(c-b)/Math.log(10))-2),this.params.animate.to.currentScore=this.currentScore,this.params.animate.to.bestScore=this.bestScore,this.params.animate.to.parScore=this.parScore,a(this)},ScoreBar.prototype.setScores=function(a,b){b="undefined"!=typeof b?b:!0,void 0!==a.score&&this.setScore(a.score,!1),void 0!==a.best&&this.setBest(a.best,!1),void 0!==a.par&&this.setPar(a.par,!1),b&&this.recalc()},ScoreBar.prototype.setScore=function(a,b){b="undefined"!=typeof b?b:!0,this.currentScore=a,a>this.bestScore&&this.setBest(a,!1),b&&this.recalc()},ScoreBar.prototype.setBest=function(a,b){b="undefined"!=typeof b?b:!0,this.bestScore=a,b&&this.recalc()},ScoreBar.prototype.setPar=function(a,b){b="undefined"!=typeof b?b:!0,this.parScore=a,b&&this.recalc()},ScoreBar.prototype.fireEvent=function(a){a.target=this;for(var b in this.listeners[a.type])a.listenerId=b,this.listeners[a.type][b][0].call(this.listeners[a.type][b][1],a)},ScoreBar.prototype.addListener=function(a,b,c){return void 0===this.listeners[a]&&(this.listeners[a]=[]),this.listeners[a].push([b,c]),this.listeners[a].length-1},ScoreBar.prototype.removeListener=function(a,b){delete this.listeners[a][b]};