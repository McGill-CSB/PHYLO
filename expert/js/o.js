function ButtonColumn(a){this.canvas=a,this.canvas.controller=this,this.ctx=a.getContext("2d"),this.buttons=[];var b,c=[new BCIcon({icon:"hdd",style:"white"}),new BCIcon({icon:"folder-open",style:"white"})],d=[["Save States"],["Best",null,c[1]],[this.getScoreForState("Best")],["1",c[0],c[1]],[this.getScoreForState("1")],["2",c[0],c[1]],[this.getScoreForState("2")]],e=[[""],["Best",null,function(){var a=localStorage.getItem(args.id+"-Best");a&&(a=JSON.parse(a),loadState(a))}],[],["1",function(){var a=getCurrentState();localStorage.setItem(args.id+"-1",JSON.stringify(a)),this.setScoreForState("1",a.score)},function(){var a=localStorage.getItem(args.id+"-1");a&&(a=JSON.parse(a),loadState(a))}],[],["2",function(){var a=getCurrentState();localStorage.setItem(args.id+"-2",JSON.stringify(a)),this.setScoreForState("2",a.score)},function(){var a=localStorage.getItem(args.id+"-2");a&&(a=JSON.parse(a),loadState(a))}],[]];for(b in c)c[b].addListener("changed",function(){this.draw()},this);for(this.data=[],b=0;b<d.length;b++){var f=b*G_H,c=[d[b][0]];d[b][1]?(button=new BCButton(~~(a.width-2*BC_BUTTON_W),~~(f+(G_H-BC_BUTTON_H)/2),d[b][1],BC_BUTTON_W,BC_BUTTON_H),this.buttons.push(button),c.push(button)):c.push(null),d[b][2]?(button=new BCButton(~~(a.width-BC_BUTTON_W),~~(f+(G_H-BC_BUTTON_H)/2),d[b][2],BC_BUTTON_W,BC_BUTTON_H),c.push(button),this.buttons.push(button)):c.push(null),this.data.push(c)}for(b=function(a){var b,c=$(this).offset(),d=a.pageX-c.left,c=a.pageY-c.top,e=!1;for(b in this.controller.buttons)d>this.controller.buttons[b].x&&d<this.controller.buttons[b].x+this.controller.buttons[b].width&&c>this.controller.buttons[b].y&&c<this.controller.buttons[b].y+this.controller.buttons[b].height?(this.controller.buttons[b].setOver(!0)&&(e=!0),"mousedown"==a.type&&this.controller.buttons[b].setDown(!0)?e=!0:"mouseup"==a.type&&this.controller.buttons[b].setDown(!1)&&(e=!0),"mouseup"==a.type&&this.controller.buttons[b].fireEvent(new $.Event("clicked"))):this.controller.buttons[b].setOver(!1)&&(e=!0);e&&this.controller.draw()},$(this.canvas).mousemove(b),$(this.canvas).mousedown(b),$(this.canvas).mouseup(b),$(this.canvas).mouseout(function(){var a,b=!1;for(a in this.controller.buttons)this.controller.buttons[a].setOver(!1)&&(b=!0),this.controller.buttons[a].setDown(!1)&&(b=!0);b&&this.controller.draw()}),b=0;b<e.length;b++)for(a=0;a<e[b].length;a++)null!=this.data[b][a]&&"object"==typeof this.data[b][a]&&"function"==typeof e[b][a]&&this.data[b][a].addListener("clicked",e[b][a],this)}function BCButton(a,b,c,d,e){this.x=a,this.y=b,this.icon=c,this.width=d,this.height=e,this.listeners=[],this.over=!1}function BCIcon(a){BCIcon.inited||BCIcon.init(),a.icon?(this.x=BCIcon.coords[a.icon].x,this.y=BCIcon.coords[a.icon].y):(this.x=a.x,this.y=a.y),this.style="undefined"!=typeof a.style?a.style:"black",this.image=BCIcon.images[this.style],this.height=this.width=14,this.listeners=[],BCIcon.allInstances.push(this)}function FitchCalculator(){this.GAP_EXT=-1,this.GAP_OPEN=-4,this.CHARS={T:1,A:2,G:4,C:8,".":16},this.CHARS_INDEX={T:0,A:1,G:2,C:3,".":4},this.RCHARS=["T","A","G","C","."],this.SCORE_MATRIX={A:{A:1,C:-1,G:-1,T:-1,".":-1},C:{A:-1,C:1,G:-1,T:-1,".":-1},G:{A:-1,C:-1,G:1,T:-1,".":-1},T:{A:-1,C:-1,G:-1,T:1,".":-1},".":{A:-1,C:-1,G:-1,T:-1,".":0}},this.GAP_MATRIX={A:{A:0,C:0,G:0,T:0,".":1},C:{A:0,C:0,G:0,T:0,".":1},G:{A:0,C:0,G:0,T:0,".":1},T:{A:0,C:0,G:0,T:0,".":1},".":{A:1,C:1,G:1,T:1,".":0}}}function DumpObjectIndented(a,b){var c="";null==b&&(b="");for(var d in a){var e=a[d];"string"==typeof e?e="'"+e+"'":"object"==typeof e&&(e instanceof Array?e="[ "+e+" ]":(e=DumpObjectIndented(e,b+"  "),e="\n"+b+"{\n"+e+"\n"+b+"}")),c+=b+"'"+d+"' : "+e+",\n"}return c.replace(/,\n$/,"")}function FoldCalculator(a){this.SHARP=4,this.THRESHOLD=10,this.p={A:{A:0,C:0,G:0,U:2,".":0},C:{A:0,C:0,G:4,U:0,".":0},G:{A:0,C:4,G:0,U:1,".":0},U:{A:2,C:0,G:1,U:0,".":0},".":{A:0,C:0,G:0,U:0,".":0}},this.po={A:{A:0,C:0,G:0,U:1,".":0},C:{A:0,C:0,G:1,U:0,".":0},G:{A:0,C:1,G:0,U:0,".":0},U:{A:1,C:0,G:0,U:0,".":0},".":{A:0,C:0,G:0,U:0,".":0}},this.diffMatrix={"<":{"<":[0,0,0],">":[1,0,0],".":[0,0,1]},">":{"<":[1,0,0],">":[0,0,0],".":[0,0,1]},".":{"<":[0,1,0],">":[0,1,0],".":[0,0,0]}},this.original=a.fold,this.sequences=a.sequences}function getSequences(a){var b="ajax/fetch.php?";args.space&&(b=b+"space="+args.space+"&"),args.name&&(b=b+"name="+args.name+"&"),b=args.id?b+"id="+args.id+"&":b+"id=3871&",$.getJSON(b,function(b){var c=parseInput(b);a(c,b)})}function parseInput(a){var b=[];!function f(a,b){a instanceof Array?(f(a[0],b),f(a[1],b)):b.push(a)}(a,b);for(var a=Array(b.length),c=0;c<b.length;c++){a[c]=[];var d,e;for(e=d=0;d<b[c].length;d++,e++)switch(b[c].charAt(d)){case"A":a[c][e]={id:0,colCount:d};break;case"U":case"T":a[c][e]={id:1,colCount:d};break;case"C":a[c][e]={id:2,colCount:d};break;case"G":a[c][e]={id:3,colCount:d};break;default:e--}}return a}function setLanguage(a){a||(a="en-us"),function(a,b){$.getJSON(LANG_DIR+a+LANG_EXT,function(c){console.log(LANG_DIR+a+LANG_EXT),b(c)})}(a,function(a){LANG=a,console.log("lang set"),$("label[for='stats-matches']").html(LANG.body.play.gameselect.game_board.field_9),$("label[for='stats-gapexts']").html(LANG.body.play.gameselect.game_board.field_12),$("label[for='stats-stage']").html(LANG.body.play.gameselect.game_board.field_3),$("label[for='stats-mismatches']").html(LANG.body.play.gameselect.game_board.field_10),$("label[for='stats-gaps']").html(LANG.body.play.gameselect.game_board.field_11),$("label[for='stats-par']").html(LANG.body.play.gameselect.game_board.field_2),$("label[for='scores-best']").html(LANG.body.play.gameselect.game_board.field_4),$("label[for='scores-score']").html(LANG.body.play.gameselect.game_board.field_1),Language.data=a})}function MessageBox(a){this._area=$("#"+a),this._area.bind("mousedown",function(){return!1})}function ColourConversion(){return!0}function ScoreBar(a){return this.canvas=a,this.ctx=a.getContext("2d"),this.currentScore=10,this.parScore=this.bestScore=0,this.params={animate:{from:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},to:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},current:{left:0,right:0,grid:10,bestScore:0,parScore:0,currentScore:0},interval:20,duration:500,handle:null,start:null,circIn:function(a){return 1-Math.sin(Math.acos(a))},circOut:function(a){return Math.sin(Math.acos(1-a))},circInOut:function(a){return.5>a?.5-Math.sin(Math.acos(2*a))/2:.5+Math.sin(Math.acos(2-2*a))/2},step:function(a,b){b.animate.current.left=b.animate.from.left+(b.animate.to.left-b.animate.from.left)*a,b.animate.current.right=b.animate.from.right+(b.animate.to.right-b.animate.from.right)*a,b.animate.current.currentScore=b.animate.from.currentScore+(b.animate.to.currentScore-b.animate.from.currentScore)*a,b.animate.current.bestScore=b.animate.from.bestScore+(b.animate.to.bestScore-b.animate.from.bestScore)*a,b.animate.current.parScore=b.animate.from.parScore+(b.animate.to.parScore-b.animate.from.parScore)*a,b.animate.current.grid=Math.pow(10,Math.floor(Math.log(b.animate.current.right-b.animate.current.left)/Math.log(10)-.4))}},barHeight:.4,leftBlank:100,rightBlank:100,colours:{gridLine:"rgba(200,200,200,0.3)",gridText:"rgba(200,200,200,0.9)",bestScoreLine:"rgb(120,250,120)",parScoreLine:"rgb(120,120,250)",bestScoreText:"rgb(120,250,120)",parScoreText:"rgb(120,120,250)",parBackground:"",barLow:[0,1,.5],barMid:[.2,1,.5],barHigh:[.44,1,.5],barRange:30,barAlpha:.9,barTextFill:"white",barTextShadow:"rgba(0,0,0,0.9)",scoreText:"rgba(220,220,220,0.9)"}},this.listeners={"best-click":[]},this.params.animate.draw=this.draw,!0}function reset(a,b){if(!resetting){resetting=!0,clearInterval(drawThread),clearInterval(calcThread),pos=[],multisel=null,originaltree=b,ancestorpos=[],globalredraw={fitch:!1},currenttree=null,bestscore=-1e4;for(var c=0;c<a.length;c++)pos[c]=[],createRow(c,c*G_H,a[c]),finalize(c);vp=[],fitchCalculator=new FitchCalculator,originaltree=b,$(document).unbind(),canvas=$("#drawing-area").unbind().get(0),canvas.width=V_W,canvas.height=V_H,ctx=canvas.getContext("2d"),tcanvas=$("#tree-area").unbind().get(0),tcanvas.width=T_W,tcanvas.height=T_H,tctx=tcanvas.getContext("2d"),viewport=$("#viewport").unbind().get(0),viewport.width=VP_W,viewport.height=VP_H,vctx=viewport.getContext("2d"),c=$("#scorebar-area").unbind().get(0),c.width=SB_W,c.height=SB_H,sb=new ScoreBar(c),sb.setScores({score:0,best:0,par:0}),c=$("#buttoncolumn-area").unbind().get(0),c.width=BC_W,c.height=BC_H,bc=new ButtonColumn(c),bc.draw(),setDrag(),setViewportDrag(),recalc(),resetOverrideTree(),vp.redraw=!0,pos.redraw=!0,drawThread=setInterval(draw,33),fitchrecalcneeded=!0,recalcFitch(),calcThread=setInterval(recalcFitch,400),resetting=!1}}function init(a,b){loadImages(function(){reset(a,b)})}function loadImages(a){function b(){d.count<e?(console.log("still waiting"),setTimeout(b,20)):(console.log("images loaded"),a())}for(var c=function(a,b,c){var d=new Image;d.onload=function(){c.count+=1,b.push(this)},d.onerror=function(){c.count+=1},d.src=a},d={count:0},e=0,f=0;f<T_IMAGES_NAMES.length;f++)c(T_IMAGES_DIR+T_IMAGES_NAMES[f],T_IMAGES,d),e++;setTimeout(b,0)}function findMaxLength(){for(var a=0,b=0;b<pos.length;b++)pos[b][pos[b].length-1].left>a&&(a=pos[b][pos[b].length-1].left);return a=Math.ceil(a/G_W+1),console.log("max "+a),a}function GameState(a,b){this.stage=a,this.tree=b,this.score=sb.currentScore}function getCurrentState(){var a=extractCurrentTree();return new GameState(args.id,a)}function loadState(a){args.id=a.stage;var b=parseInput(a.tree);reset(b,a.tree)}function extractCurrentTree(){for(var a=Array(pos.length),b=findMaxLength(),c=["A","T","C","G"],d=0;d<pos.length;d++){var e,f=Array(b);for(e=0;b>e;e++)f[e]=".";for(e=0;e<pos[d].length;e++)f[~~((pos[d][e].left+G_W/2)/G_W)]=c[pos[d][e].kind];a[d]=f.join("")}return FitchCalculator.buildTree(originaltree,a)}function recalcFitch(){if(fitchrecalcneeded){fitchrecalcneeded=!1;var a=extractCurrentTree(),a=fitch.getFinalTree(a,overridetree);if(currentancestor?(currentancestorn=FitchCalculator.treeops.getNodeIndex(currenttree,currentancestor),0>currentancestorn&&(currentancestorn=0)):currentancestorn=0,currentancestor=FitchCalculator.treeops.findNthNode(a.tree,currentancestorn),createAncestorRow(currentancestor.stringancestor),$("#stats-matches").text(a.info.match),$("#stats-gapexts").text(a.info.gap_ext),$("#stats-mismatches").text(a.info.mismatch),$("#stats-gaps").text(a.info.gap_open),$("#scores-score").text(a.score),sb.setScore(a.score),a.score>bestscore){$("#scores-best").text(a.score),bestscore=a.score;var b=localStorage.getItem(args.id+"-Best");b&&JSON.parse(b).score<bestscore&&(b=getCurrentState(),console.log(b),localStorage.setItem(args.id+"-Best",JSON.stringify(b)),bc.setScoreForState("Best",b.score))}currenttree=a.tree,pos.redraw=!0,globalredraw.fitch=!0}}function createAncestorRow(a){var b,c,d=[],e=[];for(c=b=0;b<a.length;b++,c++)switch(a.charAt(b)){case"A":d[c]={id:0,colCount:b};break;case"U":case"T":d[c]={id:1,colCount:b};break;case"C":d[c]={id:2,colCount:b};break;case"G":d[c]={id:3,colCount:b};break;default:c--}for(b=0;b<d.length;b++)3<d[b].id||(e[b]=[],e[b].row=V_ANCESTOR_ROW,e[b].left=d[b].colCount*G_W,e[b].top=V_ANCESTOR_ROW*G_H,e[b].redraw=!0,e[b].kind=d[b].id);ancestorpos=e}function parseFoldOutput(a){for(var b=[],c=[],d=0,e=0;d<a.length;d++)switch(a.charAt(d)){case"<":c.push(d);break;case">":b[e++]={0:c.pop(),1:d}}return b.sort(function(a,b){return a[0]-b[0]}),b}function setDrag(){var a,b=null,c=0,d=!1,e="";$(document).mousedown(function(a){if(console.log(e),"select"!=e){var f=$(canvas).offset(),g=a.pageX-f.left-S_MINX,h=a.pageY-f.top-S_MINY,i=~~(h/G_H);if(b=null,d=!0,i!=V_ANCESTOR_ROW){if(i>=0&&i<pos.length)for(a=0;a<pos[i].length;a++)if(pos[i][a].left+G_W>g&&pos[i][a].left<g){if(b=pos[i][a],b.drag=!0,c=g-pos[i][a].left,multisel)for(multisel.x=g,multisel.y=h,a=0;a<pos.length;a++)for(f=0;f<pos[a].length;f++)pos[a][f].selected&&(pos[a][f].drag=!0,pos[a][f].oldleft=pos[a][f].left);break}null==b&&(c=g),e="main"}else{for(a=0;a<ancestorpos.length;a++)if(ancestorpos[a].left+G_W>g&&ancestorpos[a].left<g){$("#ancestor-selection-box").css({top:ancestorpos[a].top+f.top-B_W,left:ancestorpos[a].left+f.left+S_MINX-B_W}).show();break}e="ancestor-change"}}}),$(document).mouseup(function(c){switch(d=!1,e){case"main":if(null!=b){if(b.drag=!1,multisel)for(c=0;c<pos.length;c++)finalize(c);else finalize(b.row);resetOverrideTree(),b=null}else{for(c=0;c<pos.length;c++)for(var f=0;f<pos[c].length;f++)pos[c][f].selected=!1,pos[c][f].drag=!1;multisel=null,e="",pos.redraw=!0}break;case"viewport":S_MINX=~~S_MINX,vp.redraw=!0,pos.redraw=!0;break;case"select":$("#selection-box").hide(),multisel.state="selected",e="";break;case"ancestor-change":var c=ancestorGetDistances(c.pageX,c.pageY),f=$(canvas).offset(),g=$("#ancestor-selection-box").offset();$("#ancestor-selection-box").hide();var h={top:1,left:0,bottom:3,right:2};setOverride(currentancestor,~~((g.left-f.left-S_MINX+G_W)/G_W),.7<c[c.dir]?h[c.dir]:4),fitchrecalcneeded=!0,a=null,e=""}}),$(document).mousemove(function(a){if(0===a.which&&(d=!1),d)switch(e){case"main":if(null!=b){var f=a.pageX-$(canvas).offset().left;if(multisel){for(var f=multisel.x+S_MINX-f,g=0;g<pos.length;g++)for(var h=0;h<pos[g].length;h++)pos[g][h].selected&&(pos[g][h].left=pos[g][h].oldleft-f);pos.redraw=!0}else b.left=f-S_MINX-c;fitchrecalcneeded=!0,recalc()}else f=a.pageX-$(canvas).offset().left,S_MINX=-(c-f),S_MINX=Math.min(Math.max(-S_W+V_W,S_MINX),0),VP_VP_LEFT=-(S_MINX/G_W*VP_B_W),pos.redraw=!0;break;case"ancestor-change":f=$(canvas).offset(),ancestorSetBorderColours(ancestorGetDistances(a.pageX,a.pageY));break;case"viewport":f=a.pageX-$(viewport).offset().left,VP_VP_LEFT=Math.min(Math.max(0,f-VP_VP_W/2),VP_W-VP_VP_W),S_MINX=-(VP_VP_LEFT/VP_B_W*G_W),vp.redraw=!0,pos.redraw=!0}else switch(e){case"select":if("start"==multisel.state){multisel.p2.x=a.pageX,multisel.p2.y=a.pageY;var g=multisel.p1.y>multisel.p2.y?multisel.p2.y:multisel.p1.y,a=multisel.p1.x>multisel.p2.x?multisel.p2.x:multisel.p1.x,i=Math.abs(multisel.p1.x-multisel.p2.x),h=Math.abs(multisel.p1.y-multisel.p2.y),f=$(canvas).offset(),j=~~((g-f.top-S_MINY)/G_H),k=~~((g+h-f.top-S_MINY)/G_H);for(b.offset({top:g,left:a}).width(i).height(h),g=0;g<pos.length;g++)for(h=0;h<pos[g].length;h++)pos[g][h].selected=!1;for(g=j>=0?j:0;g<pos.length&&k>=g;g++){for(h=0;h<pos[g].length&&!(pos[g][h].left+f.left+S_MINX+G_W>a);h++);for(;h<pos[g].length&&pos[g][h].left+f.left+S_MINX<i+a;h++)pos[g][h].selected=!0}pos.redraw=!0}}}),$(document).dblclick(function(a){if(multisel){for(a=0;a<pos.length;a++)for(var c=0;c<pos[a].length;c++)pos[a][c].selected=!1,pos[a][c].drag=!1;multisel=null,e="",pos.redraw=!0}else b=$("#selection-box").show().offset({top:a.pageY,left:a.pageX}).width(0).height(0),e="select",multisel={state:"start",p1:{x:a.pageX,y:a.pageY},p2:{x:a.pageX,y:a.pageY}}}),$(viewport).mousedown(function(a){return"select"!=e?(a=a.pageX-$(viewport).offset().left,d=!0,c=a,e="viewport",!1):void 0}),$(tcanvas).mousemove(function(b){var c=$(tcanvas).offset(),b=function d(a,b,c){if(a instanceof Object&&void 0!=a[0]){if(a.ancestorlocation&&a.ancestorlocation.left<b&&a.ancestorlocation.left+a.ancestorlocation.width>b&&a.ancestorlocation.top<c&&a.ancestorlocation.top+a.ancestorlocation.height>c)return a;var e=d(a[0],b,c);return null!=e?e:e=d(a[1],b,c)}return null}(currenttree,b.pageX-c.left,b.pageY-c.top);null!=b?b!=currentancestor&&(a=currentancestor,currentancestor=b,drawTree(tctx),createAncestorRow(currentancestor.stringancestor),pos.redraw=!0):(currentancestor!=a&&null!=a&&(currentancestor=a,drawTree(tctx),createAncestorRow(currentancestor.stringancestor),pos.redraw=!0),a=null)}),$(tcanvas).mousedown(function(){a=currentancestor})}function setOverride(a,b,c){console.log(b,c),a=function d(a,b,c){if(a instanceof Object&&void 0!=a[0]){if(c==a)return b;var e=d(a[0],b[0],c);return null!=e?e:e=d(a[1],b[1],c)}return null}(currenttree,overridetree,a),null!=a&&(a.value[b]=c)}function resetOverrideTree(){var a=FitchCalculator.seqLength(originaltree)+20;overridetree=FitchCalculator.buildTree(originaltree,Array(pos.length)),function b(a,c){a instanceof Object&&void 0!=a[0]&&(b(a[0],c),b(a[1],c),a.value=Array(c))}(overridetree,a),overridetree.set=!1}function ancestorGetDistances(a,b){var c=$("#ancestor-selection-box").offset(),d={top:-.2,left:-.2,bottom:-.2,right:-.2},e=a-(c.left+1.5*B_W),f=b-(c.top+1.5*B_H),c=-Math.atan2(f,e),e=Math.min(Math.max(Math.sqrt(e*e+f*f)/(2*B_W),.2),1);return Math.abs(c)<Math.PI/4?(d.right=1,d.dir="right"):Math.abs(c)>.75*Math.PI?(d.left=1,d.dir="left"):c>0?(d.top=1,d.dir="top"):(d.bottom=1,d.dir="bottom"),d.top=d.top*e+.4,d.left=d.left*e+.4,d.right=d.right*e+.4,d.bottom=d.bottom*e+.4,d}function ancestorSetBorderColours(a){$("#ancestor-selection-box").css({"border-top-color":B_COLOUR_A[0]+a.top+")","border-left-color":B_COLOUR_A[1]+a.left+")","border-bottom-color":B_COLOUR_A[2]+a.bottom+")","border-right-color":B_COLOUR_A[3]+a.right+")"})}function setViewportDrag(){}function createRow(a,b,c){if(void 0!=args.rand)var d=generateRandomRowPositions(c.length,S_W-G_W);for(var e=0;e<c.length;e++)3<c[e].id||(pos[a][e]=[],pos[a][e].row=a,pos[a][e].left=args.rand?S_MINX+d[e]:c[e].colCount*G_W,pos[a][e].top=b,pos[a][e].redraw=!0,pos[a][e].kind=c[e].id)}function generateRandomRowPositions(a,b){for(var c=[],d=0;a>d;d++)c[d]=Math.floor(Math.random()*b);return c=c.sort(function(a,b){return a-b})}function finalize(a){for(var b=0;b<pos[a].length;b++)pos[a][b].left=~~((pos[a][b].left+G_W/2)/G_W)*G_W,pos[a][b].redraw=!0}function recalc(){var a,b,c=!1,d=0;for(a=0;a<pos.length;a++){for(c=!1,d=S_W,b=pos[a].length-1;b>=0;b--)pos[a][b].drag?(c=!0,pos[a][b].redraw=!0):c&&pos[a][b].left>d-G_W&&(pos[a][b].left=d-G_W,pos[a][b].redraw=!0),d=pos[a][b].left;for(c=!1,d=-G_W,b=0;b<pos[a].length;b++)pos[a][b].drag?(c=!0,pos[a][b].redraw=!0):c&&pos[a][b].left<d+G_W&&(pos[a][b].left=d+G_W,pos[a][b].redraw=!0),d=pos[a][b].left;for(d=-G_W,b=0;b<pos[a].length;b++)pos[a][b].left<d+G_W&&(pos[a][b].left=d+G_W,pos[a][b].redraw=!0),d=pos[a][b].left;for(d=S_W,b=pos[a].length-1;b>=0;b--)pos[a][b].left>d-G_W&&(pos[a][b].left=d-G_W,pos[a][b].redraw=!0),d=pos[a][b].left}}function drawRow(a,b,c){for(var d=0;d<pos[b].length;d++)pos[b][d].left+S_MINX+B_XOFFSET>=-G_W&&pos[b][d].left+S_MINX+B_XOFFSET+G_W<=V_W+G_W&&(c?(a.fillStyle=B_COLOUR_H[pos[b][d].kind],a.fillRect(pos[b][d].left+S_MINX+B_XOFFSET,pos[b][d].top+S_MINY+B_YOFFSET,B_W,B_H),a.strokeStyle=BS_COLOUR_H[pos[b][d].kind],a.strokeRect(pos[b][d].left+S_MINX+B_XOFFSET,pos[b][d].top+S_MINY+B_YOFFSET,B_W,B_H)):(a.fillStyle=pos[b][d].selected?B_COLOUR_S[pos[b][d].kind]:B_COLOUR[pos[b][d].kind],a.fillRect(pos[b][d].left+S_MINX+B_XOFFSET,pos[b][d].top+S_MINY+B_YOFFSET,B_W,B_H))),pos[b][d].redraw=!1}function drawAncestorRow(a){for(var b=0;b<ancestorpos.length;b++)ancestorpos[b].left+S_MINX+B_XOFFSET>=-G_W&&ancestorpos[b].left+S_MINX+B_XOFFSET+G_W<=V_W+G_W&&(a.fillStyle=B_COLOUR[ancestorpos[b].kind],a.fillRect(ancestorpos[b].left+S_MINX+B_XOFFSET,ancestorpos[b].top+S_MINY+B_YOFFSET,B_W,B_H)),ancestorpos[b].redraw=!1}function draw(){if(resizeinfo.resize&&(canvas.width=resizeinfo.canvas_width,viewport.width=resizeinfo.viewport_width,resizeinfo.resize=!1,pos.redraw=!0),pos.redraw){ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.restore(),generateGrid(ctx);for(var a=0;a<pos.length;a++)drawRow(ctx,a);drawAncestorRow(ctx),pos.redraw=!1,drawViewport(!0)}else{var b=!1;for(ctx.save(),a=0;a<pos.length;a++){var c;for(c=0;c<pos[a].length&&!pos[a][c].redraw;c++);c<pos[a].length&&(ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,G_H*a+S_MINY,V_W,G_H),b=!0,pos[a].redraw=!0)}if(ctx.restore(),b){for(generateGrid(ctx),a=0;a<pos.length;a++)if(pos[a].redraw){for(c=0;c<pos[a].length;c++)pos[a][c].left+S_MINX+B_XOFFSET>=-G_W&&pos[a][c].left+S_MINX+B_XOFFSET+G_W<=V_W+G_W&&(ctx.fillStyle=pos[a][c].selected?B_COLOUR_S[pos[a][c].kind]:B_COLOUR[pos[a][c].kind],ctx.fillRect(pos[a][c].left+S_MINX+B_XOFFSET,pos[a][c].top+S_MINY+B_YOFFSET,B_W,B_H)),pos[a][c].redraw=!1;pos[a].redraw=!1}drawAncestorRow(ctx),drawViewport(!0)}else drawViewport(!1)}globalredraw.fitch&&(drawTree(tctx),globalredraw.fitch=!1)}function drawViewport(a){if(a||vp.redraw){vctx.save(),vctx.setTransform(1,0,0,1,0,0),vctx.clearRect(0,0,viewport.width,viewport.height),vctx.restore();for(var b=a=0;b<pos.length;b++)for(var c=0;c<pos[b].length;c++)vctx.fillStyle=B_COLOUR[pos[b][c].kind],a=~~(pos[b][c].left/G_W),vctx.fillRect(a*VP_B_W,b*VP_B_H,VP_B_W,VP_B_H);vctx.fillStyle=VP_OVERLAY_COLOUR,vctx.fillRect(0,0,VP_VP_LEFT,VP_VP_H),vctx.fillRect(VP_VP_LEFT+VP_VP_W,0,VP_W-VP_VP_LEFT-VP_VP_W,VP_VP_H),vctx.strokeStyle=VP_BORDER_COLOUR,vctx.lineWidth=VP_BORDER_WIDTH,vctx.strokeRect(VP_VP_LEFT,0,VP_VP_W,VP_VP_H),vp.redraw=!1}}function generateGrid(a){a.beginPath();for(var b=0;G_ROW>=b;b++)a.moveTo(-.5,S_MINY+b*G_H+.5),a.lineTo(V_W+.5,S_MINY+b*G_H+.5);for(var b=~~(V_W/G_W)+1,c=0;b>=c;c++)a.moveTo(S_MINX%G_W+c*G_W+.5,S_MINY+.5),a.lineTo(S_MINX%G_W+c*G_W+.5,S_MINY+G_ROW*G_H-1+.5);a.lineWidth=1,a.strokeStyle=G_COLOUR,a.stroke(),a.closePath()}function drawTree(a){var b=function f(b,c){b instanceof Object&&void 0!=b[0]&&(f(b[0],c),f(b[1],c),(!c&&b.node!=currentancestor||c&&b.node==currentancestor)&&a.rect(T_W-(b.depth*T_SIZE_H+T_RIGHT)-T_ANCESTOR_BUTTON_W/2,T_TOP+~~(b.height*T_SIZE_V)-T_ANCESTOR_BUTTON_H/2,T_ANCESTOR_BUTTON_W,T_ANCESTOR_BUTTON_H),b.node.ancestorlocation={top:T_TOP+~~(b.height*T_SIZE_V)-T_ANCESTOR_BUTTON_W/2,left:T_W-(b.depth*T_SIZE_H+T_RIGHT)-T_ANCESTOR_BUTTON_W/2,width:T_ANCESTOR_BUTTON_W,height:T_ANCESTOR_BUTTON_H})},c=function g(b){b instanceof Object&&void 0!=b[0]&&(g(b[0]),g(b[1]),a.fillText(0<b.node.score?"+"+b.node.score:""+b.node.score,T_W-(b.depth*T_SIZE_H+T_RIGHT)-3,T_TOP+~~(b.height*T_SIZE_V)))},d={};!function h(a,b,c){if(a instanceof Object&&void 0!=a[0]){var d=0;b[0]={},b[1]={};var e=h(a[0],b[0],c),c=h(a[1],b[1],c),d=Math.max(e.depth,d),d=Math.max(c.depth,d);b.depth=d+1,b.height=(e.height+c.height)/2,b.from=e.height,b.to=c.height,b.node=a}else b.depth=0,b.height=c[0],c[0]+=1;return b}(currenttree,d,[0]),a.save(),a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,tcanvas.width,tcanvas.height),a.restore();var e=a.createLinearGradient(T_W,0,T_W-T_BACKGROUND_GRID_W,0);for(e.addColorStop(0,G_COLOUR),e.addColorStop(1,G_COLOUR_A),a.strokeStyle=e,a.lineWidth=1,a.beginPath(),e=0;G_ROW>=e;e++)a.moveTo(T_W-T_BACKGROUND_GRID_W+.5,e*G_H+.5),a.lineTo(T_W+.5,e*G_H+.5);a.closePath(),a.stroke(),function i(b,c){return b instanceof Object&&void 0!=b[0]?(i(b[0],b.depth,c),c=i(b[1],b.depth)):a.drawImage(T_IMAGES[c],0,0,T_IMAGES[c].width,T_IMAGES[c].height,T_W-30,T_TOP+~~(b.height*T_SIZE_V)-T_IMAGES_DRAW_H/2,T_IMAGES_DRAW_W,T_IMAGES_DRAW_H),c+1}(d,0),a.font="12px sans-serif",a.textBaseline="middle",a.textAlign="right",a.fillStyle=T_COLOUR,a.fillText("Ancestor",T_W-5,G_H*V_ANCESTOR_ROW+G_H/2),a.fillStyle=T_COLOUR,a.strokeStyle=T_COLOUR,a.beginPath(),function j(b,c){b instanceof Object&&void 0!=b[0]&&(j(b[0],b.depth),j(b[1],b.depth),a.moveTo(T_W-(b.depth*T_SIZE_H+T_RIGHT),T_TOP+~~(b.from*T_SIZE_V)),a.lineTo(T_W-(b.depth*T_SIZE_H+T_RIGHT),T_TOP+~~(b.to*T_SIZE_V))),a.moveTo(T_W-(b.depth*T_SIZE_H+T_RIGHT),T_TOP+~~(b.height*T_SIZE_V)),a.lineTo(T_W-(c*T_SIZE_H+T_RIGHT),T_TOP+~~(b.height*T_SIZE_V))}(d,8),a.closePath(),a.lineWidth=T_THICKNESS,a.lineCap="square",a.stroke(),a.fill(),a.fillStyle=T_COLOUR,a.beginPath(),b(d,!1),a.closePath(),a.fill(),a.fillStyle=T_COLOUR_S,a.beginPath(),b(d,!0),a.closePath(),a.fill(),args.ui_showscore&&(a.font="10px sans-serif",a.textBaseline="bottom",a.textAlign="right",a.fillStyle=T_COLOUR,c(d))}ButtonColumn.prototype.setScoreForState=function(a,b){for(var c=0;c<this.data.length-1;c++)this.data[c][0]&&this.data[c][0]==a&&(this.data[c+1][0]=b);this.draw()},ButtonColumn.prototype.getScoreForState=function(a){return(a=localStorage.getItem(args.id+"-"+a))?(a=JSON.parse(a),a.score):null},ButtonColumn.prototype.draw=function(){var a=this.ctx,b=this.canvas.width,c=this.canvas.height;for(a.save(),a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,b,c),a.restore(),b=a.createLinearGradient(0,0,BC_BACKGROUND_GRID_W,0),b.addColorStop(0,G_COLOUR),b.addColorStop(1,G_COLOUR_A),a.strokeStyle=b,a.fillStyle=G_COLOUR,a.lineWidth=1,a.beginPath(),b=0;G_ROW>=b;b++)a.moveTo(-.5,b*G_H+.5),a.lineTo(BC_BACKGROUND_GRID_W+.5,b*G_H+.5);for(a.closePath(),a.stroke(),a.font="10pt sans-serif",a.textBaseline="middle",a.textAlign="left",b=0;b<this.data.length;b++)c=b*G_H,this.data[b][0]&&"string"==typeof this.data[b][0]?a.fillText(this.data[b][0],5,c+G_H/2):this.data[b][0]&&"number"==typeof this.data[b][0]&&(a.save(),a.font="8pt sans-serif",a.textAlign="right",a.textBaseline="top",a.fillText("Score: "+this.data[b][0],BC_W-BC_BUTTON_W/3,c),a.restore()),this.data[b][1]&&(a.save(),a.translate(this.data[b][1].x,this.data[b][1].y),this.data[b][1].draw(a),a.restore()),this.data[b][2]&&(a.save(),a.translate(this.data[b][2].x,this.data[b][2].y),this.data[b][2].draw(a),a.restore())},BCButton.prototype.fireEvent=function(a){a.target=this;for(var b in this.listeners[a.type])a.listenerId=b,this.listeners[a.type][b][0].call(this.listeners[a.type][b][1],a)},BCButton.prototype.setDown=function(a){return a!=this.down?(this.down=a,!0):!1},BCButton.prototype.setOver=function(a){return a!=this.over?(this.over=a,!0):!1},BCButton.prototype.addListener=function(a,b,c){return void 0===this.listeners[a]&&(this.listeners[a]=[]),this.listeners[a].push([b,c]),this.listeners[a].length-1},BCButton.prototype.removeListener=function(a,b){delete this.listeners[a][b]},BCButton.prototype.draw=function(a){if(a.clearRect(0,0,this.width,this.height),this.down?(a.fillStyle=BC_BUTTON_DOWN_COLOUR,a.fillRect(0,0,this.width,this.height)):this.over&&(a.fillStyle=BC_BUTTON_OVER_COLOUR,a.fillRect(0,0,this.width,this.height)),this.icon&&this.icon.image){var b=~~((this.width-this.icon.width)/2),c=~~((this.height-this.icon.height)/2);a.drawImage(this.icon.image,this.icon.x,this.icon.y,this.icon.width,this.icon.height,b>=0?b:0,c>=0?c:0,this.icon.width,this.icon.height)}},BCIcon.imageSrcs={black:"img/glyphicons-halflings.png",white:"img/glyphicons-halflings-white.png"},BCIcon.coords={download:{x:120,y:24},upload:{x:144,y:24},"folder-open":{x:408,y:120},hdd:{x:0,y:144}},BCIcon.images={},BCIcon.inited=!1,BCIcon.allInstances=[],BCIcon.init=function(){BCIcon.inited=!0;for(var a in BCIcon.imageSrcs){var b=new Image;b.key=a,b.onload=function(){for(var a in BCIcon.allInstances)BCIcon.allInstances[a].style==this.key&&(BCIcon.allInstances[a].image=this,BCIcon.allInstances[a].fireEvent(new $.Event("changed")))},b.onerror=function(){console.log("error loading BCIcon: "+this.key)},b.src=BCIcon.imageSrcs[a],BCIcon.images[a]=b}},BCIcon.prototype.changeStyle=function(a){this.path=this.paths[a]},BCIcon.prototype.fireEvent=function(a){a.target=this;for(var b in this.listeners[a.type])a.listenerId=b,this.listeners[a.type][b][0].call(this.listeners[a.type][b][1],a)},BCIcon.prototype.addListener=function(a,b,c){return void 0===this.listeners[a]&&(this.listeners[a]=[]),this.listeners[a].push([b,c]),this.listeners[a].length-1},BCIcon.prototype.removeListener=function(a,b){delete this.listeners[a][b]},$(function(){var a=$("<div></div>").attr({id:"debug-wrapper",width:800}).css({width:800,margin:20});a.bind("mousedown",function(){return!1}),$("#page").append(a),$.getScript("js/lib/jquery-ui-1.8.17.custom.min.js").done(function(){var b=$("<div></div>").attr({id:"debug-scoring"});b.append($("<p></p>").append($("<label></label>").attr({"for":"debug-score-input"}).text("Scoring Threshold")).append($("<input></input>").attr({type:"text",id:"debug-score-input",value:"10"})).append($("<div></div>").attr({id:"debug-score-slider",width:300}).slider({min:1,max:100,value:10,slide:function(a,b){$("#debug-score-input").val(b.value),folder.THRESHOLD=b.value,foldrecalcneeded=!0}}))),$("#debug-score-input").val($("#debug-score-slider").slider("value")),a.append(b)}).fail(function(){console.log("Could not load jquery UI")})}),FitchCalculator.diffSeqs=function(){for(var a,b=0,c=0,d=0,e=0;e<fold.length;e++)a=this.diffMatrix[this.original.charAt(e)][fold.charAt(e)],b+=a[0],c+=a[1],d+=a[2];return{difference:b,extra:c,missing:d}},FitchCalculator.treeops={},FitchCalculator.treeops.findNode=function(a,b){return function c(a,b,d){if(a instanceof Object&&void 0!=a[0]){if(b.bind(d)(a))return a;var e=c(a[0],b,d);return null!=e?e:c(a[1],b,d)}return null}(a,b,this)},FitchCalculator.treeops.findNthNode=function(a,b){return function c(a,d){if(a instanceof Object&&void 0!=a[0]){if(d.count==b)return a;d.count+=1;var e=c(a[0],d);return null!=e?e:c(a[1],d)}return null}(a,{count:0})},FitchCalculator.treeops.getNodeIndex=function(a,b){return function c(a,d){if(a instanceof Object&&void 0!=a[0]){if(a==b)return d.count;d.count+=1;var e=c(a[0],d);return null!=e?e:c(a[1],d)}return-1}(a,{count:0})},FitchCalculator.buildTree=function a(b,c){return b instanceof Array?[a(b[0],c),a(b[1],c)]:c.shift()},FitchCalculator.seqLength=function(a){return a instanceof Array?FitchCalculator.seqLength(a[0]):a.length},FitchCalculator.prototype.getFinalTree=function(a,b){var c=function(a){return a-=1431655765&a>>1,a=(858993459&a>>2)+(858993459&a),a=252645135&(a>>4)+a,a+=a>>8,63&a+(a>>16)},d=function i(a,b,d,e){if(a instanceof Array){void 0==d.seq&&(d.seq=[],d.ancestor=[],d[0]={},d[1]={});var f=i(a[0],b,d[0],e[0]),a=i(a[1],b,d[1],e[1]);return d.seq[b]=void 0==e.value||void 0==e.value[b]?0==(f&a)?f|a:f&a:1<<e.value[b],d.ancestor[b]=Math.min(c((d.seq[b]&-d.seq[b])-1),4),d.seq[b]}return void 0==d.seq&&(d.seq=[],d.ancestor=[]),d.seq[b]=a,d.ancestor[b]=Math.min(c((a&-a)-1),4),a};console.log(c(15)),console.log(c(0));for(var e=[],f=FitchCalculator.seqLength(a),g=0;f>g;g++){var h=this.diffLocation(a,g);e[g]=h.tree}for(f=[],g=0;g<e.length;g++)d(e[g],g,f,b);for(d="",g=0;g<f.ancestor.length;g++)d+=this.RCHARS[f.ancestor[g]];return function j(a,b){if(a instanceof Array||a instanceof Object&&void 0!=a[0]){j(a[0],b),j(a[1],b),a.stringancestor="";for(var c=0;c<a.ancestor.length;c++)a.stringancestor+=b[a.ancestor[c]]}}(f,this.RCHARS),g={match:0,mismatch:0,gap_ext:0,gap_open:0},e=this.scoreTreeAlignment.bind(this)(f,g),{ancestor:d,score:e,info:g,tree:f}},FitchCalculator.prototype.scoreTreeAlignment=function b(a,c){if(a instanceof Object&&void 0!=a[0]){var d,e=0;return d=0+b.bind(this)(a[0],c),d+=b.bind(this)(a[1],c),e+=this.scoreAlignment(a.ancestor,a[0].ancestor,c),e+=this.scoreAlignment(a.ancestor,a[1].ancestor,c),a.score=d+e,d+e}return 0},FitchCalculator.prototype.scoreAlignment=function(a,b,c){for(var d=0,e=!1,f=0,g=!0,h=0;h<a.length;h++)1==this.GAP_MATRIX[this.RCHARS[a[h]]][this.RCHARS[b[h]]]?g||(e?(d+=this.GAP_EXT,c.gap_ext+=1,f++):(d+=this.GAP_OPEN,e=!0,c.gap_open+=1,f=1)):(g=e=!1,d+=this.SCORE_MATRIX[this.RCHARS[a[h]]][this.RCHARS[b[h]]],0<this.SCORE_MATRIX[this.RCHARS[a[h]]][this.RCHARS[b[h]]]?c.match+=1:c.mismatch+=1);return e&&(d-=(f-1)*this.GAP_EXT+this.GAP_OPEN,c.gap_ext-=f-1,c.gap_open-=1),d},FitchCalculator.prototype.diffLocation=function(a,b){var c=[0],d=this.extractLocation(a,b);return{ancestor:function e(a,b){if(a instanceof Array){var c=e(a[0],b),d=e(a[1],b);return 0==(c&d)?(b[0]++,a.seq=c|d):a.seq=c&d,a.seq}return a}(d,c),parsimony:c[0],tree:d}},FitchCalculator.prototype.extractLocation=function(a,b){return a instanceof Array?[this.extractLocation(a[0],b),this.extractLocation(a[1],b)]:this.CHARS[a.charAt(b)]};var fitch=new FitchCalculator;FoldCalculator.prototype.diffOriginal=function(a){for(var b,c=0,d=0,e=0,f=0;f<a.length;f++)b=this.diffMatrix[this.original.charAt(f)][a.charAt(f)],c+=b[0],d+=b[1],e+=b[2];return{difference:c,extra:d,missing:e}},FoldCalculator.prototype.score=function(){return this.foldAll(this.sequences,this.p)},FoldCalculator.prototype.setOriginal=function(a){this.original=a},FoldCalculator.prototype.setAll=function(a){this.original=a.fold,this.sequences=a.sequences},FoldCalculator.prototype.setSeqs=function(a){this.sequences=a
},FoldCalculator.prototype.getOriginal=function(){return this.original},FoldCalculator.sums=function(a,b,c,d){for(var e=0,f=0;f<c.length;f++)e+=d[c[f].charAt(a)][c[f].charAt(b)];return e},FoldCalculator.prototype.backtrack=function(a,b,c,d,e){var f;f=d[b*c+a],0-this.THRESHOLD<=f&&-1>=f?(console.log("go neg"),e[a]=".",e[b]=".",this.backtrack(a+1,b-1,c,d,e)):0>f?(e[a]="<",e[b]=">",this.backtrack(a+1,b-1,c,d,e)):f>=a&&b>=f+1&&(this.backtrack(a,f,c,d,e),this.backtrack(f+1,b,c,d,e))},FoldCalculator.prototype.foldAll=function(a,b){for(var c={},d=a[0].length,e=Array(d*d),f=0;d>f;f++)e[f*d+f]=0;for(f=1;d>f;f++)e[f*d+f-1]=0;for(f=d-1;f>=0;f--)for(var g=f;d>g;g++)if(g-f<=this.SHARP)e[g*d+f]=-1,e[f*d+g]=0;else{var h=FoldCalculator.sums(f,g,a,b),i=e[(f+1)*d+g-1]+h;e[g*d+f]=-1-h;for(var j=f;g>j;j++)h=e[f*d+j]+e[(j+1)*d+g],h>i&&(i=h,e[g*d+f]=j);e[f*d+g]=i}for(c.score=e[d-1],g=[],this.backtrack(0,d-1,d,e,g),d="",f=0;f<g.length;f++)d=null!=g[f]?d+g[f]:d+".";return c.fold=d,c},$(function(){$("#stage-redirect").bind("keydown",function(a){if(13==(a.keyCode?a.keyCode:a.which?a.which:a.charCode)){var b=document.location.search.replace("?",""),c="";if(b){var d,b=b.split("&");for(d in b)-1==b[d].indexOf("id")&&(c+=b[d]+"&")}return c="?"+c+"id="+$(this).val(),document.location.search=c,a.preventDefault(),!1}return!0})});var Language={};$(function(){setLanguage()}),MessageBox.prototype.println=function(a){return this._area.val(this._area.val()+a+"\n"),this._area.scrollTop(this._area.get(0).scrollHeight),this},MessageBox.prototype.append=function(a){return this._area.val(this._area.val()+a),this},MessageBox.prototype.clear=function(){return this._area.val(""),this},MessageBox.prototype.setText=function(a){return this._area.val(a),console.log(this._area.val()),this},MessageBox.prototype.getText=function(){return this._area.val()},ColourConversion.rgbToRgbaString=function(a,b){return"rgba("+~~(a[0]+.5)+","+~~(a[1]+.5)+","+~~(a[2]+.5)+","+b+")"},ColourConversion.rgbToHsl=function(a,b,c){var d,a=a/255,b=b/255,c=c/255,e=Math.max(a,b,c),f=Math.min(a,b,c),g=(e+f)/2;if(e==f)d=f=0;else{var h=e-f,f=g>.5?h/(2-e-f):h/(e+f);switch(e){case a:d=(b-c)/h+(c>b?6:0);break;case b:d=(c-a)/h+2;break;case c:d=(a-b)/h+4}d/=6}return[d,f,g]},ColourConversion.hslToRgb=function(a,b,c){if(0==b)c=b=a=c;else var d=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+6*(b-a)*(2/3-c):a},e=.5>c?c*(1+b):c+b-c*b,f=2*c-e,c=d(f,e,a+1/3),b=d(f,e,a),a=d(f,e,a-1/3);return[255*c,255*b,255*a]},ScoreBar.alignToPixel=function(a){return~~a+.5},ScoreBar.prototype.getBarColour=function(a){void 0===a&&(a=this.params.animate.current.currentScore);var b=this.params.colours.barRange,b=Math.abs(a-this.parScore)/b;b>1&&(b=1);var c=this.params.colours.barMid,d=this.params.colours.barLow;return a>=this.parScore&&(d=this.params.colours.barHigh),ColourConversion.rgbToRgbaString(ColourConversion.hslToRgb(b*(d[0]-c[0])+c[0],b*(d[1]-c[1])+c[1],b*(d[2]-c[2])+c[2]),this.params.colours.barAlpha)},ScoreBar.prototype.draw=function(){"undefined"!=typeof resizeinfo&&resizeinfo.resize&&(this.canvas.width=resizeinfo.scorebar_width);var a=this.ctx,b=this.canvas.width,c=this.canvas.height,d=this.params.animate;a.save(),a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,b,c),a.restore();var b=b-(this.params.leftBlank+this.params.rightBlank),e=b/(d.current.right-d.current.left),f=Math.abs(Math.min(d.current.left,0))/(d.current.right-d.current.left)*b+this.params.leftBlank;a.font="10pt sans-serif",a.textBaseline="bottom",a.textAlign="center",a.strokeStyle=this.params.colours.gridLine,a.fillStyle=this.params.colours.gridText,a.lineWidth=1,a.beginPath();for(var g=f;g<=this.canvas.width;)a.moveTo(ScoreBar.alignToPixel(g),0),a.lineTo(ScoreBar.alignToPixel(g),c),a.fillText(""+Math.round(10*((g-f)/e))/10,g,c),g+=d.current.grid*e;for(g=f;g>=0;)a.moveTo(ScoreBar.alignToPixel(g),0),a.lineTo(ScoreBar.alignToPixel(g),c),a.fillText(Math.round(10*((g-f)/e))/10,g,c),g-=d.current.grid*e;a.closePath(),a.stroke(),g=this.params.animate.current.currentScore*e,a.fillStyle=this.getBarColour(),a.textBaseline="middle",d=ScoreBar.getRect.call(this,this.params.animate.current.currentScore,e,f),a.beginPath(),a.rect(d.left,d.top,d.width,d.height),a.closePath(),a.fill(),a.fillStyle=this.params.colours.barTextFill,a.lineWidth=2,a.save(),a.shadowColor=this.params.colours.barTextShadow,a.shadowOffsetX=a.shadowOffsetY=0,a.shadowBlur=2,a.fillText(Math.round(this.params.animate.current.currentScore),g/2+f,c/2),a.restore(),g=ScoreBar.alignToPixel(f+this.params.animate.current.bestScore*e),a.textBaseline="top",a.textAlign="left",a.fillStyle=this.params.colours.bestScoreText,a.fillText("Best: "+Math.round(this.params.animate.current.bestScore),b+this.params.leftBlank+10,0),a.beginPath(),a.moveTo(g,0),a.lineTo(g,c),a.closePath(),a.strokeStyle=this.params.colours.bestScoreLine,a.stroke(),g=ScoreBar.alignToPixel(f+this.params.animate.current.parScore*e),a.textBaseline="middle",a.fillStyle=this.params.colours.parScoreText,a.fillText("Par: "+Math.round(this.params.animate.current.parScore),b+this.params.leftBlank+10,c/2),a.beginPath(),a.moveTo(g,0),a.lineTo(g,c),a.closePath(),a.strokeStyle=this.params.colours.parScoreLine,a.stroke(),a.save(),a.font="22pt sans-serif",a.fillStyle=this.params.colours.scoreText,a.textAlign="center",a.textBaseline="middle",a.fillText(Math.round(this.params.animate.current.currentScore),this.params.leftBlank/2,c/2),a.restore()},ScoreBar.getRect=function(a,b,c){var d={},e=this.canvas.height;return d.top=e*(1-this.params.barHeight)/2,d.height=this.params.barHeight*e,d.left=Math.min(a*b+c,c),d.width=Math.abs(a*b),d},ScoreBar.prototype.recalc=function(){var a=1.2*Math.min(this.currentScore,this.bestScore,this.parScore),b=1.2*Math.max(this.currentScore,this.bestScore,this.parScore);if(a>0&&(a=0),0>b&&(b=0),10>b-a)var c=5-(b-a)/2,b=b+c,a=a-c;this.params.animate.from.left=this.params.animate.current.left,this.params.animate.from.right=this.params.animate.current.right,this.params.animate.from.grid=this.params.animate.current.grid,this.params.animate.from.currentScore=this.params.animate.current.currentScore,this.params.animate.from.bestScore=this.params.animate.current.bestScore,this.params.animate.from.parScore=this.params.animate.current.parScore,this.params.animate.to.left=a,this.params.animate.to.right=b,this.params.animate.to.grid=Math.pow(10,Math.floor(Math.log(b-a)/Math.log(10))-2),this.params.animate.to.currentScore=this.currentScore,this.params.animate.to.bestScore=this.bestScore,this.params.animate.to.parScore=this.parScore,function(a){var b=a.params.animate;null!=b.handle&&(clearInterval(b.handle),b.handle=null),b.start=new Date,b.handle=setInterval(function(){var c=(new Date-b.start)/b.duration;c>1&&(c=1),b.step(b.circInOut(c),a.params),a.draw(),1==c&&(clearInterval(b.handle),b.handle=null)},b.interval)}(this)},ScoreBar.prototype.setScores=function(a,b){b="undefined"!=typeof b?b:!0,void 0!==a.score&&this.setScore(a.score,!1),void 0!==a.best&&this.setBest(a.best,!1),void 0!==a.par&&this.setPar(a.par,!1),b&&this.recalc()},ScoreBar.prototype.setScore=function(a,b){b="undefined"!=typeof b?b:!0,this.currentScore=a,a>this.bestScore&&this.setBest(a,!1),b&&this.recalc()},ScoreBar.prototype.setBest=function(a,b){this.bestScore=a,("undefined"!=typeof b?b:1)&&this.recalc()},ScoreBar.prototype.setPar=function(a,b){this.parScore=a,("undefined"!=typeof b?b:1)&&this.recalc()},ScoreBar.prototype.fireEvent=function(a){a.target=this;for(var b in this.listeners[a.type])a.listenerId=b,this.listeners[a.type][b][0].call(this.listeners[a.type][b][1],a)},ScoreBar.prototype.addListener=function(a,b,c){return void 0===this.listeners[a]&&(this.listeners[a]=[]),this.listeners[a].push([b,c]),this.listeners[a].length-1},ScoreBar.prototype.removeListener=function(a,b){delete this.listeners[a][b]};var pos=[],ctx,canvas,tcanvas,tctx,viewport,vctx,vp,multisel,originaltree,ancestorpos=[],currenttree,overridetree,currentancestor,currentancestorn,globalredraw={fitch:!1},bestscore=-1e4,drawThread,calcThread,sb,bc,resetting=!1,resizeinfo={},msg,fitchrecalcneeded=!1;$(function(){getSequences(init)}),$(window).resize(function(){var a=.8*$(window).width()-T_W-BC_W;a>SIZE_MAX_WIDTH?a=SIZE_MAX_WIDTH:SIZE_MIN_WIDTH>a&&(a=SIZE_MIN_WIDTH),V_W=a,VP_B_W=a/G_COL,SB_W=VP_W=a+T_W+BC_W,resizeinfo.resize=!0,resizeinfo.canvas_width=a,resizeinfo.viewport_width=a+T_W+BC_W,resizeinfo.scorebar_width=SB_W,sb&&sb.draw()}),$(window).resize();